<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Design Studio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: center;
        }
        .controls label {
            font-weight: bold;
        }
        .rules-container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }
        .rule {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .rule select, .rule input {
            padding: 8px;
            font-size: 1em;
            width: 100%;
        }
        .buttons {
            text-align: center;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }
        .rule-label {
            font-weight: bold;
            margin-top: 10px;
        }
        .side-left, .side-right {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .add-button {
            cursor: pointer;
            color: blue;
            margin-top: 5px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .popup select, .popup input {
            margin-bottom: 10px;
        }
        .popup button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Game Design Studio</div>
        <div class="controls">
            <label for="rooms">Select Room:</label>
            <select id="rooms" onchange="loadRules()">
                <option value="">--Select Room--</option>
            </select>
        </div>
        <div class="rules-container" id="rulesContainer">
            <div class="rule-label">Rules:</div>
            <div id="rulesList"></div>
        </div>
        <div class="buttons">
            <button id="addRuleButton">Add Rule</button>
            <button onclick="saveRules()">Save Rules</button>
        </div>
    </div>
    <div class="popup" id="triggerPopup">
        <div class="popup-content">
            <h2>Add Trigger</h2>
            <select id="triggerType">
                <option value="sensor">Sensor</option>
                <option value="rule_max_executions">Rule Max Executions</option>
                <option value="tasks">Tasks</option> <!-- Added tasks option here -->
            </select>
            <div id="sensorOptions" style="display: none;">
                <label for="sensorSelect">Select Sensor:</label>
                <select id="sensorSelect"></select>
            </div>
            <div id="maxExecOptions" style="display: none;">
                <label for="maxExecInput">Max Executions:</label>
                <input type="number" id="maxExecInput" min="1" value="1">
            </div>
            <div id="taskOptions" style="display: none;"> <!-- New task options -->
                <label for="taskSelect">Select Task:</label>
                <select id="taskSelect">
                    <!-- Options will be dynamically populated -->
                </select>
                <label for="taskState">Select Task State:</label>
                <select id="taskState">
                    <option value="solved">Solved</option>
                    <option value="pending">Pending</option>
                    <option value="skipped">Skipped</option>
                </select>
            </div>
            <button onclick="addSelectedTrigger()">Add Trigger</button>
            <button onclick="closePopup()">Cancel</button>
        </div>
    </div>
    <script>
        async function loadRooms() {
            let response = await fetch('/api/rooms');
            let rooms = await response.json();
            let roomSelect = document.getElementById('rooms');
            rooms.forEach(room => {
                let option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomSelect.appendChild(option);
            });
        }

        async function loadSensorsAndMaglocks(room) {
            let response = await fetch(`/api/sensors-maglocks?room=${room}`);
            let data = await response.json();
            window.sensors = data.sensors;
            window.maglocks = data.maglocks;
        }
        async function loadRules() {
            let room = document.getElementById('rooms').value;
            if (room) {
                await loadSensorsAndMaglocks(room);
                let response = await fetch(`/api/rules/${room}`);
                let rules = await response.json();
                console.log(`Loaded rules for ${room}:`, rules);
                displayRules(rules);
            }
        }

        function displayRules(rules) {
            let rulesList = document.getElementById('rulesList');
            rulesList.innerHTML = '';
            rules.forEach(rule => {
                let ruleDiv = createRuleElement(rule);
                rulesList.appendChild(ruleDiv);
            });
        }
        function addConsequence() {
    let ruleDiv = document.querySelector('.rule:last-child .side-right');
    let newConsequenceDiv = document.createElement('div');

    let maglockSelect = document.createElement('select');
    maglockSelect.className = 'maglock-select';
    window.maglocks.forEach(maglockItem => {
        let option = document.createElement('option');
        option.value = maglockItem.name;
        option.textContent = maglockItem.name;
        maglockSelect.appendChild(option);
    });
    newConsequenceDiv.appendChild(maglockSelect);

    let actionSelect = document.createElement('select');
    actionSelect.className = 'action-select';
    ['unlock', 'lock'].forEach(act => {
        let option = document.createElement('option');
        option.value = act;
        option.textContent = act;
        actionSelect.appendChild(option);
    });
    newConsequenceDiv.appendChild(actionSelect);

    let deleteButton = document.createElement('button');
    deleteButton.textContent = 'Delete Consequence';
    deleteButton.className = 'delete-button';
    deleteButton.onclick = () => newConsequenceDiv.parentNode.removeChild(newConsequenceDiv);
    newConsequenceDiv.appendChild(deleteButton);

    ruleDiv.appendChild(newConsequenceDiv);
}
        function createRuleElement(rule) {
            let ruleDiv = document.createElement('div');
            ruleDiv.className = 'rule';
            ruleDiv.dataset.ruleId = rule.id;

            let triggersDiv = document.createElement('div');
            triggersDiv.className = 'side-left';
            triggersDiv.innerHTML = '<strong>Triggers</strong>';

            rule.triggers.forEach(trigger => {
                let triggerDiv;
                if (trigger.type === 'sensor') {
                    triggerDiv = createSensorTriggerElement(trigger.sensor);
                } else if (trigger.type === 'rule_max_executions') {
                    triggerDiv = createMaxExecutionsElement(trigger.max_executions);
                }
                triggersDiv.appendChild(triggerDiv);
            });

            let consequencesDiv = document.createElement('div');
            consequencesDiv.className = 'side-right';
            consequencesDiv.innerHTML = '<strong>Consequences</strong>';

            rule.consequences.forEach(consequence => {
                let consequenceDiv = createConsequenceElement(consequence.maglock, consequence.action);
                consequencesDiv.appendChild(consequenceDiv);
            });

            ruleDiv.appendChild(triggersDiv);
            ruleDiv.appendChild(consequencesDiv);

            return ruleDiv;
        }

        function createSensorTriggerElement(selectedSensor = '') {
            let triggerDiv = document.createElement('div');
            triggerDiv.dataset.type = 'sensor';
            let sensorSelect = document.createElement('select');
            sensorSelect.className = 'sensor-select';
            window.sensors.forEach(sensorItem => {
                let option = document.createElement('option');
                option.value = sensorItem.name;
                option.textContent = sensorItem.name;
                sensorSelect.appendChild(option);
            });
            sensorSelect.value = selectedSensor;
            triggerDiv.appendChild(sensorSelect);

            let deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete Trigger';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => triggerDiv.parentNode.removeChild(triggerDiv);
            triggerDiv.appendChild(deleteButton);

            return triggerDiv;
        }

        function createMaxExecutionsElement(maxExecutions = 1) {
            let triggerDiv = document.createElement('div');
            triggerDiv.dataset.type = 'rule_max_executions';
            triggerDiv.innerHTML = `<strong>Rule Max Executions:</strong> ${maxExecutions}`;

            let deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete Trigger';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => triggerDiv.parentNode.removeChild(triggerDiv);
            triggerDiv.appendChild(deleteButton);

            return triggerDiv;
        }

        function createConsequenceElement(selectedMaglock = '', selectedAction = 'unlock') {
            let consequenceDiv = document.createElement('div');

            let maglockSelect = document.createElement('select');
            maglockSelect.className = 'maglock-select';
            window.maglocks.forEach(maglockItem => {
                let option = document.createElement('option');
                option.value = maglockItem.name;
                option.textContent = maglockItem.name;
                maglockSelect.appendChild(option);
            });
            maglockSelect.value = selectedMaglock;
            consequenceDiv.appendChild(maglockSelect);

            let actionSelect = document.createElement('select');
            actionSelect.className = 'action-select';
            ['unlock', 'lock'].forEach(act => {
                let option = document.createElement('option');
                option.value = act;
                option.textContent = act;
                actionSelect.appendChild(option);
            });
            actionSelect.value = selectedAction;
            consequenceDiv.appendChild(actionSelect);

            let deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete Consequence';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => consequenceDiv.parentNode.removeChild(consequenceDiv);
            consequenceDiv.appendChild(deleteButton);

            return consequenceDiv;
        }

        function addRule() {
            let rulesList = document.getElementById('rulesList');
            let newRuleDiv = document.createElement('div');
            newRuleDiv.className = 'rule';

            let triggersDiv = document.createElement('div');
            triggersDiv.className = 'side-left';
            triggersDiv.innerHTML = '<strong>Triggers</strong>';

            let consequencesDiv = document.createElement('div');
            consequencesDiv.className = 'side-right';
            consequencesDiv.innerHTML = '<strong>Consequences</strong>';

            newRuleDiv.appendChild(triggersDiv);
            newRuleDiv.appendChild(consequencesDiv);

            rulesList.appendChild(newRuleDiv);

            addButton('Add Trigger', triggersDiv, showTriggerOptionsPopup);
            addButton('Add Consequence', consequencesDiv, addConsequence);
        }

        function addButton(label, container, action) {
            let button = document.createElement('button');
            button.textContent = label;
            button.className = 'add-button';
            button.onclick = action;
            container.appendChild(button);
        }

        function showTriggerOptionsPopup() {
            document.getElementById('triggerPopup').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('triggerPopup').style.display = 'none';
        }

        function addSelectedTrigger() {
    let triggerType = document.getElementById('triggerType').value;
    if (triggerType === 'sensor') {
        addSensorTrigger();
    } else if (triggerType === 'rule_max_executions') {
        addRuleMaxExecutionsTrigger();
    } else if (triggerType === 'tasks') {
        addTasksTrigger();
    }
    closePopup();
}

function addTasksTrigger() {
    let newTriggerDiv = document.createElement('div');
    newTriggerDiv.dataset.type = 'tasks';

    let taskSelect = document.createElement('select');
    taskSelect.className = 'task-select';
    taskSelect.innerHTML = '<option>Loading Tasks...</option>'; // Placeholder for loading state

    loadTasksIntoSelect(taskSelect); // Function to populate tasks into select

    newTriggerDiv.appendChild(taskSelect);

    let deleteButton = document.createElement('button');
    deleteButton.textContent = 'Delete Trigger';
    deleteButton.className = 'delete-button';
    deleteButton.onclick = () => newTriggerDiv.parentNode.removeChild(newTriggerDiv);
    newTriggerDiv.appendChild(deleteButton);

    document.querySelector('.rule:last-child .side-left').appendChild(newTriggerDiv);
}

async function loadTasksIntoSelect(taskSelect) {
    let room = document.getElementById('rooms').value;
    let response = await fetch(`/api/tasks?room=${room}`);
    let tasks = await response.json();

    taskSelect.innerHTML = ''; // Clear loading state
    if (tasks.length === 0) {
        let option = document.createElement('option');
        option.textContent = 'No tasks available';
        taskSelect.appendChild(option);
    } else {
        tasks.forEach(task => {
            let option = document.createElement('option');
            option.value = task.id;
            option.textContent = task.name;
            taskSelect.appendChild(option);
        });
    }
}
        function addSensorTrigger() {
            let selectedSensor = document.getElementById('sensorSelect').value;
            let newTriggerDiv = createSensorTriggerElement(selectedSensor);
            document.querySelector('.rule:last-child .side-left').appendChild(newTriggerDiv);
        }

        function addRuleMaxExecutionsTrigger() {
            let maxExecutions = document.getElementById('maxExecInput').value;
            let newTriggerDiv = createMaxExecutionsElement(maxExecutions);
            document.querySelector('.rule:last-child .side-left').appendChild(newTriggerDiv);
        }

        async function saveRules() {
            let room = document.getElementById('rooms').value;
            let rules = [];
            document.querySelectorAll('.rule').forEach(ruleDiv => {
                let ruleId = ruleDiv.dataset.ruleId || null;
                let triggers = [];
                ruleDiv.querySelectorAll('.sensor-select').forEach(sensorSelect => {
                    let sensor = sensorSelect.value;
                    triggers.push({ type: 'sensor', sensor });
                });
                ruleDiv.querySelectorAll('[data-type="rule_max_executions"]').forEach(maxExecDiv => {
                    let maxExecutions = parseInt(maxExecDiv.textContent.match(/\d+/)[0]);
                    triggers.push({ type: 'rule_max_executions', max_executions: maxExecutions });
                });
                let consequences = [];
                ruleDiv.querySelectorAll('.maglock-select').forEach((maglockSelect, index) => {
                    let maglock = maglockSelect.value;
                    let action = ruleDiv.querySelectorAll('.action-select')[index].value;
                    consequences.push({ maglock, action });
                });
                rules.push({ id: ruleId, triggers, consequences });
            });
            await fetch(`/api/rules/${room}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rules)
            });
            console.log(`Saved rules for ${room}:`, rules);
            loadRules();  // Reload rules after save
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadRooms();
            document.getElementById('addRuleButton').onclick = addRule;
        });
    </script>
</body>
</html>
