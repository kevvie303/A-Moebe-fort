<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Rule Cards with Subcards</title>
    <!-- Include jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- Include jQuery and jQuery UI JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- Include Dragula CSS and JavaScript -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles-rules.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles-dropdowns.css') }}">
    <style>
        .pi-card {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .services-list label {
            display: block;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="toggle-button active" data-target="rules">Edit Rules</button>
        <button class="toggle-button" data-target="states">Edit States</button>
        <button class="toggle-button" data-target="pis">Edit Pi's</button>
        <button id="back-to-room-btn">Back to Room</button>
        <button id="media-control-btn">Media Control</button>
        <button id="save-rules-btn" class="btn-green">Save Rules</button>
        <button id="save-states-btn" class="btn-green" style="display: none;">Save States</button>
        <button id="save-pis-btn" class="btn-green" style="display: none;">Save Pi's</button>
    </div>

    <div class="content">
        <h1>Rule Editor</h1>
        <div id="room-name" style="display: none;">{{ room }}</div>
        <input type="text" id="search-input" class="search-input" placeholder="Search rules...">
        <button id="add-rule-btn" class="add-rule-btn">Add New Rule</button>
        <div class="rules-container" id="rules-container"></div>
        <div id="states" class="section-container">
            <!-- Lights Section -->
            <div class="state-section" id="light">
                <h2>Lights</h2>
                <button class="add-state-btn" data-section="light">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- Sensors Section -->
            <div class="state-section" id="Sensor">
                <h2>Sensors</h2>
                <button class="add-state-btn" data-section="Sensor">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- Maglocks Section -->
            <div class="state-section" id="maglock">
                <h2>Maglocks</h2>
                <button class="add-state-btn" data-section="maglock">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- Buttons Section -->
            <div class="state-section" id="button">
                <h2>Buttons</h2>
                <button class="add-state-btn" data-section="button">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- Logic Section -->
            <div class="state-section" id="logic">
                <h2>Logic</h2>
                <button class="add-state-btn" data-section="logic">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- RFID Section -->
            <div class="state-section" id="rfid">
                <h2>RFID</h2>
                <button class="add-state-btn" data-section="rfid">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- Different Section -->
            <div class="state-section" id="different">
                <h2>Different</h2>
                <button class="add-state-btn" data-section="different">Add State</button>
                <div class="state-list"></div>
            </div>

            <!-- LEDs Section -->
            <div class="state-section" id="led">
                <h2>LEDs</h2>
                <button class="add-state-btn" data-section="led">Add State</button>
                <div class="state-list"></div>
            </div>
        </div>

        <div id="pis" class="section-container">
            <h2>Edit Pi's</h2>
            <div id="raspberry-list"></div>
        </div>
    </div>

    <div id="sound-popup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h2>Select Sound</h2>
            <div id="sound-list"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/rules.js') }}"></script>
    <script>
        $(document).ready(function () {
            const availableServices = ["mqtt", "lights_out", "actuator", "led", "sound", "dmx", "camera", "rfid", "knocker"];
            const defaultValues = {
                light: 'on, off',
                Sensor: 'Triggered, Not Triggered',
                maglock: 'locked, unlocked',
                button: 'Triggered, Not Triggered',
                logic: '',
                rfid: 'Detected, Not Detected',
                different: 'Active, Inactive',
                led: 'on, off'
            };

            // Function to set the active section
            function setActiveSection(section) {
                $('.toggle-button').removeClass('active');
                $(`.toggle-button[data-target="${section}"]`).addClass('active');
                $('.section-container').hide();
                $(`#${section}`).show();
                if (section === 'rules') {
                    $('#rules-container').show();
                    $('#search-input').show();
                    $('#add-rule-btn').show();
                    $('#save-rules-btn').show();
                    $('#save-states-btn').hide();
                    $('#save-pis-btn').hide();
                } else if (section === 'states') {
                    $('#rules-container').hide();
                    $('#search-input').hide();
                    $('#add-rule-btn').hide();
                    $('#save-rules-btn').hide();
                    $('#save-states-btn').show();
                    $('#save-pis-btn').hide();
                } else if (section === 'pis') {
                    $('#rules-container').hide();
                    $('#search-input').hide();
                    $('#add-rule-btn').hide();
                    $('#save-rules-btn').hide();
                    $('#save-states-btn').hide();
                    $('#save-pis-btn').show();
                    loadRaspberries();
                }
            }

            // Load the last active section from localStorage
            const lastActiveSection = localStorage.getItem('activeSection') || 'rules';
            setActiveSection(lastActiveSection);

            // Update the active section on button click
            $('.toggle-button').click(function() {
                const target = $(this).data('target');
                setActiveSection(target);
                localStorage.setItem('activeSection', target);
            });

            $('#back-to-room-btn').click(function () {
                window.location.href = '/rooms/{{ room }}';
            });

            $('#media-control-btn').click(function () {
                window.location.href = '/media_control';
            });

            function loadRaspberries() {
                $.get(`/get_raspberry_pis/{{ room }}`, function (pis) {
                    const piList = $('#raspberry-list');
                    piList.empty();
                    pis.forEach(pi => {
                        const piCard = document.createElement('div');
                        piCard.className = 'pi-card';

                        const hostname = document.createElement('h3');
                        hostname.textContent = pi.hostname;
                        piCard.appendChild(hostname);

                        const ipAddress = document.createElement('p');
                        ipAddress.textContent = `IP Address: ${pi.ip_address}`;
                        piCard.appendChild(ipAddress);

                        const changeIpButton = document.createElement('button');
                        changeIpButton.textContent = 'Change IP';
                        changeIpButton.className = 'change-ip-btn';
                        changeIpButton.onclick = function () {
                            const newIp = prompt('Enter new IP address:', pi.ip_address);
                            if (newIp) {
                                ipAddress.textContent = `IP Address: ${newIp}`;
                            }
                        };
                        piCard.appendChild(changeIpButton);

                        const servicesLabel = document.createElement('label');
                        servicesLabel.textContent = 'Services:';
                        piCard.appendChild(servicesLabel);

                        const servicesList = document.createElement('div');
                        servicesList.className = 'services-list';
                        servicesList.id = `services-${pi.hostname}`;

                        availableServices.forEach(service => {
                            const label = document.createElement('label');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = service;
                            if (pi.services.includes(service)) {
                                checkbox.checked = true;
                            }
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(service));
                            servicesList.appendChild(label);
                        });

                        piCard.appendChild(servicesList);
                        piList.append(piCard);
                    });
                }).fail(function() {
                    console.log('Failed to fetch Raspberry Pi data.');
                });
            }

            $('#save-pis-btn').click(function () {
                const pis = [];
                $('#raspberry-list .pi-card').each(function () {
                    const hostname = $(this).find('h3').text();
                    const ip_address = $(this).find('p').text().replace('IP Address: ', '');
                    const services = $(this).find('.services-list input:checked').map(function () {
                        return $(this).val();
                    }).get();
                    pis.push({ hostname, ip_address, services });
                });

                $.ajax({
                    url: `/save_raspberry_pis/{{ room }}`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(pis),
                    success: function () {
                        alert('Pi\'s saved successfully!');
                    },
                    error: function () {
                        alert('Failed to save Pi\'s.');
                    }
                });
            });

            function loadSounds() {
                $.get('/get_sounds', function (sounds) {
                    const soundList = $('#sound-list');
                    soundList.empty();
                    sounds.forEach(sound => {
                        const soundButton = $(`<button class="sound-button">${sound}</button>`);
                        soundButton.click(function () {
                            $('#selected-sound').val(sound);
                        });
                        soundList.append(soundButton);
                    });
                });
            }

            $('.add-action[data-type="play-sound"]').click(function () {
                $('#sound-popup').show();
                loadSounds();
                loadRaspberries();
            });

            $('#apply-sound-btn').click(function () {
                const selectedSound = $('#selected-sound').val();
                const volume = $('#volume').val();
                const selectedPis = $('#raspberry-list input:checked').map(function () {
                    return $(this).val();
                }).get();
                // Handle the selected sound, volume, and Pis
                // ... your code to handle the selected sound, volume, and Pis ...
                $('#sound-popup').hide();
            });

            $('.close').click(function () {
                $('#sound-popup').hide();
            });

            $(window).click(function (event) {
                if (event.target.id === 'sound-popup') {
                    $('#sound-popup').hide();
                }
            });
        });
    </script>
</body>
</html>
